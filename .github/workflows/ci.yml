name: CI/CD Pipeline - Library Management System

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  PYTHON_VERSION: '3.10'

jobs:
  initiation:
    name: ğŸš€ Initialisation du Pipeline
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¢ Message de dÃ©marrage
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸš€ DÃ‰MARRAGE DU PIPELINE CI/CD                        â•‘"
          echo "â•‘   ğŸ“š Projet: Library Management System                  â•‘"
          echo "â•‘   ğŸ—„ï¸  Base de donnÃ©es: MySQL                           â•‘"
          echo "â•‘   ğŸ‘¤ DÃ©clenchÃ© par: ${{ github.actor }}                 â•‘"
          echo "â•‘   ğŸŒ¿ Branche: ${{ github.ref_name }}                    â•‘"
          echo "â•‘   ğŸ“‹ Event: ${{ github.event_name }}                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  discover-services:
    name: ğŸ” DÃ©couverte des Microservices
    runs-on: ubuntu-latest
    needs: initiation
    outputs:
      services: ${{ steps.find-services.outputs.services }}

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ” DÃ©couverte des services
        id: find-services
        run: |
          echo "ğŸ” Recherche des microservices..."
          SERVICES=$(find backend -maxdepth 1 -type d -name "*_service" | sed 's|backend/||' | sort)
          if [ -z "$SERVICES" ]; then
            echo "âš ï¸  Aucun service trouvÃ©, utilisation de user_service par dÃ©faut"
            SERVICES="user_service"
          fi
          echo "ğŸ“¦ Services trouvÃ©s:"
          echo "$SERVICES"
          # Convert to JSON array
          JSON_ARRAY=$(echo "$SERVICES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "services=$JSON_ARRAY" >> $GITHUB_OUTPUT
          echo "services=$JSON_ARRAY" >> $GITHUB_ENV

  tests-unitaires:
    name: ğŸ§ª Tests Unitaires (Tous les Services)
    runs-on: ubuntu-latest
    needs: [initiation, discover-services]
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.services) }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: library_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ Configuration de Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: â³ Attente que MySQL soit prÃªt
        run: |
          echo "â³ Attente du dÃ©marrage de MySQL..."
          for i in {1..60}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot --silent 2>/dev/null; then
              echo "âœ… MySQL est prÃªt!"
              mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT VERSION();" 2>/dev/null && break
            fi
            echo "â±ï¸  Tentative $i/60..."
            sleep 2
          done

          # Verify MySQL is accessible
          mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SHOW DATABASES;" || {
            echo "âŒ MySQL n'est pas accessible"
            exit 1
          }

      - name: ğŸ”§ Configuration de la base de donnÃ©es
        run: |
          echo "ğŸ”§ Configuration de la base de donnÃ©es de test..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot << EOF
          CREATE DATABASE IF NOT EXISTS library_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
          GRANT ALL PRIVILEGES ON library_test.* TO 'root'@'%';
          FLUSH PRIVILEGES;
          SHOW DATABASES;
          EOF
          echo "âœ… Base de donnÃ©es configurÃ©e"

      - name: ğŸ“¦ Installation des dÃ©pendances systÃ¨me
        run: |
          sudo apt-get update
          sudo apt-get install -y libmysqlclient-dev pkg-config

      - name: ğŸ“¦ Installation des dÃ©pendances Python globales
        working-directory: ./backend
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances globales..."
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install mysqlclient pytest pytest-cov pytest-django

      - name: ğŸ“¦ Installation des dÃ©pendances du service
        working-directory: ./backend/${{ matrix.service }}
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances pour ${{ matrix.service }}..."
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      - name: ğŸ”§ Configuration de l'environnement de test
        working-directory: ./backend/${{ matrix.service }}
        run: |
          echo "ğŸ”§ Configuration des variables d'environnement..."

          # Create .env file for Django settings
          cat > .env << EOF
          # Database Configuration
          DB_ENGINE=django.db.backends.mysql
          DB_NAME=library_test
          DB_USER=root
          DB_PASSWORD=root
          DB_HOST=127.0.0.1
          DB_PORT=3306

          # Django Settings
          SECRET_KEY=test-secret-key-for-ci-pipeline
          DEBUG=True
          ALLOWED_HOSTS=localhost,127.0.0.1

          # Test Configuration
          DJANGO_SETTINGS_MODULE=config.settings
          PYTHONPATH=/home/runner/work/Library-management-system/Library-management-system/backend/${{ matrix.service }}
          EOF

          echo "âœ… Fichier .env crÃ©Ã©"

          # Export to environment
          export DB_ENGINE=django.db.backends.mysql
          export DB_NAME=library_test
          export DB_USER=root
          export DB_PASSWORD=root
          export DB_HOST=127.0.0.1
          export DB_PORT=3306
          export SECRET_KEY=test-secret-key-for-ci-pipeline
          export DEBUG=True
          export DJANGO_SETTINGS_MODULE=config.settings

      - name: ğŸ” VÃ©rification de la connexion MySQL
        working-directory: ./backend/${{ matrix.service }}
        run: |
          echo "ğŸ” Test de connexion MySQL..."
          python << EOF
          import os
          import MySQLdb

          try:
              conn = MySQLdb.connect(
                  host='127.0.0.1',
                  port=3306,
                  user='root',
                  passwd='root',
                  db='library_test'
              )
              print("âœ… Connexion Python-MySQL rÃ©ussie!")
              cursor = conn.cursor()
              cursor.execute("SELECT VERSION()")
              version = cursor.fetchone()
              print(f"ğŸ“Š MySQL Version: {version[0]}")
              cursor.close()
              conn.close()
          except Exception as e:
              print(f"âŒ Erreur de connexion: {e}")
              exit(1)
          EOF

      - name: ğŸ—„ï¸ Migrations Django
        working-directory: ./backend/${{ matrix.service }}
        env:
          DB_ENGINE: django.db.backends.mysql
          DB_NAME: library_test
          DB_USER: root
          DB_PASSWORD: root
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          SECRET_KEY: test-secret-key-for-ci-pipeline
          DJANGO_SETTINGS_MODULE: config.settings
        run: |
          echo "ğŸ—„ï¸ ExÃ©cution des migrations Django..."

          # Check if manage.py exists
          if [ -f "manage.py" ]; then
            python manage.py makemigrations --noinput || echo "âš ï¸ Pas de nouvelles migrations"
            python manage.py migrate --noinput || echo "âš ï¸ Migration Ã©chouÃ©e"
            echo "âœ… Migrations appliquÃ©es"
          else
            echo "â„¹ï¸ Pas de manage.py trouvÃ©, skip migrations"
          fi

      - name: ğŸ§ª ExÃ©cution des tests du service
        working-directory: ./backend/${{ matrix.service }}
        env:
          DB_ENGINE: django.db.backends.mysql
          DB_NAME: library_test
          DB_USER: root
          DB_PASSWORD: root
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          SECRET_KEY: test-secret-key-for-ci-pipeline
          DJANGO_SETTINGS_MODULE: config.settings
          PYTHONDONTWRITEBYTECODE: 1
        run: |
          echo "ğŸ§ª LANCEMENT DES TESTS POUR ${{ matrix.service }}"
          echo "ğŸ”— Connexion Ã  MySQL: root@127.0.0.1:3306/library_test"

          # Find test files
          TEST_FILES=$(find . -name "test_*.py" -o -path "*/tests/test_*.py" 2>/dev/null | wc -l)
          echo "ğŸ“‹ Nombre de fichiers de test trouvÃ©s: $TEST_FILES"

          if [ "$TEST_FILES" -gt 0 ]; then
            # Run pytest with coverage
            python -m pytest \
              --verbose \
              --tb=short \
              --cov=. \
              --cov-report=xml:coverage_${{ matrix.service }}.xml \
              --cov-report=term-missing \
              --cov-report=html \
              --maxfail=5 \
              -p no:warnings \
              || TEST_EXIT_CODE=$?
            
            # Check if tests ran
            if [ -f "coverage_${{ matrix.service }}.xml" ]; then
              echo "âœ… Tests exÃ©cutÃ©s avec succÃ¨s"
              ls -lh coverage_${{ matrix.service }}.xml
            else
              echo "âš ï¸ Fichier coverage non gÃ©nÃ©rÃ©, crÃ©ation d'un rapport vide"
              echo '<?xml version="1.0" ?><coverage version="7.0"><sources><source>.</source></sources><packages/></coverage>' > coverage_${{ matrix.service }}.xml
            fi
            
            # Exit with test result
            exit ${TEST_EXIT_CODE:-0}
          else
            echo "âš ï¸ Aucun test trouvÃ© pour ${{ matrix.service }}"
            echo '<?xml version="1.0" ?><coverage version="7.0"><sources><source>.</source></sources><packages/></coverage>' > coverage_${{ matrix.service }}.xml
          fi

      - name: ğŸ“¤ Upload du rapport de couverture
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-${{ matrix.service }}
          path: backend/${{ matrix.service }}/coverage_${{ matrix.service }}.xml
          retention-days: 30

      - name: ğŸ“¤ Upload du rapport HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-html-${{ matrix.service }}
          path: backend/${{ matrix.service }}/htmlcov/
          retention-days: 7

  combine-coverage:
    name: ğŸ“Š Combinaison des Rapports de Couverture
    runs-on: ubuntu-latest
    needs: [discover-services, tests-unitaires]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ“¥ TÃ©lÃ©chargement des rapports de couverture
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports
          pattern: coverage-*
          merge-multiple: true

      - name: ğŸ“Š Combinaison des rapports
        run: |
          echo "ğŸ“Š Combinaison des rapports de couverture..."
          mkdir -p combined-coverage

          # Find all coverage XML files
          COVERAGE_FILES=$(find coverage-reports -name "coverage_*.xml" -o -name "coverage.xml" 2>/dev/null)

          if [ -n "$COVERAGE_FILES" ]; then
            echo "ğŸ“„ Fichiers de couverture trouvÃ©s:"
            echo "$COVERAGE_FILES"
            
            # Copy first coverage file as base
            FIRST_FILE=$(echo "$COVERAGE_FILES" | head -n 1)
            cp "$FIRST_FILE" coverage.xml
            echo "âœ… Rapport principal crÃ©Ã© Ã  partir de: $FIRST_FILE"
          else
            echo "âš ï¸ Aucun rapport trouvÃ©, crÃ©ation d'un rapport factice"
            echo '<?xml version="1.0" ?><coverage version="7.0"><sources><source>.</source></sources><packages/></coverage>' > coverage.xml
          fi

          # Display summary
          echo ""
          echo "ğŸ“Š RÃ©sumÃ© des rapports:"
          ls -lh coverage-reports/ 2>/dev/null || echo "Aucun rapport"

      - name: ğŸ“¤ Upload du rapport combinÃ©
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml-combined
          path: coverage.xml
          retention-days: 30

  qualite-du-code:
    name: ğŸ” Analyse QualitÃ© du Code (SonarQube)
    runs-on: ubuntu-latest
    needs: [tests-unitaires, combine-coverage]
    if: (github.event_name == 'pull_request' || github.ref == 'refs/heads/main') && always()

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ TÃ©lÃ©chargement du rapport de couverture
        uses: actions/download-artifact@v4
        with:
          name: coverage-xml-combined
          path: ./

      - name: ğŸ” VÃ©rification avant SonarQube
        run: |
          echo "ğŸ“ Contenu du workspace:"
          ls -la

          if [ -f "coverage.xml" ]; then
            echo "âœ… coverage.xml trouvÃ©"
            head -n 5 coverage.xml
          else
            echo "âš ï¸ coverage.xml manquant - crÃ©ation d'un rapport minimal"
            echo '<?xml version="1.0" ?><coverage version="7.0"><sources><source>.</source></sources><packages/></coverage>' > coverage.xml
          fi

          echo ""
          echo "ğŸ“‹ Type d'analyse:"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "   ğŸ”€ Pull Request #${{ github.event.pull_request.number }}"
            echo "   ğŸŒ¿ ${{ github.base_ref }} â† ${{ github.head_ref }}"
          else
            echo "   ğŸ¯ Main Branch: ${{ github.ref_name }}"
          fi

      - name: ğŸ” Analyse SonarQube (Main Branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=library-system-management
            -Dsonar.projectKey=AymenZahed_Library-management-system
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.sources=backend
            -Dsonar.exclusions=**/tests/**,**/migrations/**
            -Dsonar.coverage.minimumCoverage=0

      - name: ğŸ” Analyse SonarQube (Pull Request)
        if: github.event_name == 'pull_request'
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=mma-project-v2
            -Dsonar.projectKey=MMA-PROJECT-V2_Library-Management-System
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.sources=backend
            -Dsonar.exclusions=**/tests/**,**/migrations/**
            -Dsonar.coverage.minimumCoverage=0
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}

  qualite-du-code-info:
    name: â„¹ï¸ Info SonarQube (Push non-main)
    runs-on: ubuntu-latest
    needs: tests-unitaires
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'

    steps:
      - name: â„¹ï¸ Information Plan Gratuit
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     â„¹ï¸  ANALYSE SONARQUBE - PUSH SUR ${{ github.ref_name }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Tests unitaires: RÃ‰USSIS"
          echo "ğŸ’¡ Pour analyse SonarQube: crÃ©er une PR vers main"

  pipeline-summary:
    name: ğŸ“‹ RÃ©sumÃ© du Pipeline
    runs-on: ubuntu-latest
    needs: [initiation, discover-services, tests-unitaires]
    if: always()

    steps:
      - name: ğŸ“Š Statut du Pipeline
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ğŸ“Š RÃ‰SUMÃ‰ DU PIPELINE CI/CD                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“… Date: $(date)"
          echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
          echo "ğŸ—„ï¸  Base de donnÃ©es: MySQL 8.0"
          echo ""
          echo "âœ… Statut des jobs:"
          echo "   1ï¸âƒ£  Initiation: ${{ needs.initiation.result }}"
          echo "   2ï¸âƒ£  DÃ©couverte services: ${{ needs.discover-services.result }}"
          echo "   3ï¸âƒ£  Tests unitaires: ${{ needs.tests-unitaires.result }}"
          echo ""

          if [[ "${{ needs.tests-unitaires.result }}" == "success" ]]; then
            echo "ğŸ‰ PIPELINE RÃ‰USSI!"
            exit 0
          else
            echo "âŒ PIPELINE Ã‰CHOUÃ‰ - VÃ©rifiez les logs"
            exit 1
          fi
